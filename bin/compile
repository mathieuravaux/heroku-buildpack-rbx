#!/usr/bin/env bash

indent() {
  sed -u 's/^/       /'
}

download() {
  curl -L -s -S $@
}

main_task() {
  echo -n "-----> "
  echo $@
}

sub_task() {
  echo $@ | indent
} 


ensure_env() {
  echo "Ensuring suitable environment"
  mkdir -p $CACHE
  mkdir -p $BUILD
  export $PATH="$CACHE:$PATH"
}

clear_cache() {
  rm -rf $CACHE/*
}

check_version() {
  [ "$CURRENT_VERSION" != "$RBX_VERSION+$BUILDPACK_VERSION" ] 
}


install_rbx() {
  local old_path=$PWD
    if ! which rbx &>/dev/null && [ "$1" != "-f" ] ; then
      main_task "Rubinius install detected, checking version..." 

        
        if check_version ; then
          sub_task "Old version detected, re-building"
            clear_cache
            install_rbx -f
        else 
          sub_task "Version is up to date" 
        fi

    else 
      main_task "Installing Rubinius"
        mkdir -p /tmp/rbx

        sub_task "Downloading" 
          download $RBX_URL/$RBX_VERSION | tar -zx$VERBOSE
          mv rubinius-rubinius-* /tmp/rbx/rubinius

        sub_task "Compiling" 
          cd /tmp/rbx/rubinius
          rbx_compile
    fi 
    
  cd $old_path

  return 0
}

rbx_compile() {
  ruby configure --prefix $CACHE --default-version 1.9
  rake install 
} &>/dev/null

  install_base_gems() {
    main_task "Installing Necessary Gems"
    sub_task "Installing bundler"
    rbx -S gem install bundler

    sub_task "Installing foreman"
    rbx -S gem install foreman
  }

  init_environment() {
    main_task "Initializing Basic Environment" 
    mkdir -p $BUILD 
    mkdir -p $CACHE

    mkdir -p $CACHE/gems/{bin,install}
    gem install -q -n $CACHE/gems/bin -i $CACHE/gems/install --no-rdoc --no-ri rake &>/dev/null

    touch $CACHE/rbx_version

    export PATH="$CACHE:$PATH"
  }


  bootstrap() {
    init_environment
    install_rbx
    install_base_gems
  }

  install_gems() {
    # if gemfile exists, bundle
    if [ -s $1/Gemfile ]; then
      echo "Gemfile found, bundling" | indent
      foreman run bundle
    fi
  }


  set -e

  set -x

  VERBOSE=
  RBX_URL=https://github.com/rubinius/rubinius/tarball
  RBX_VERSION="master"
  BUILDPACK_VERSION="0.0.1"
  BUILD=$1
  CACHE=$2



  bootstrap
  install_gems
  exit 1
  foreman start


