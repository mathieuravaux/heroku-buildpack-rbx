#!/bin/sh

indent() {
  sed -u 's/^/       /'
}


ensure_env() {
  echo "Ensuring suitable environment"
  mkdir -p $CACHE
  mkdir -p $BUILD
  export $PATH="$CACHE:$PATH"
}


install_rbx() {
  local old_path=$PWD

    #if ! which rbx &>/dev/null ; then
      #echo "rbx install detected" | indent
        
      #return 0
    #else 
      echo "------> Installing rbx-head, with 1.9 support" | indent

      mkdir -p /tmp/rbx

      echo "Downloading Rubinius" | indent
        curl -L $RBX_URL/release-$RBX_VERSION | tar -zx$VERBOSE
        mv rubinius-rubinius-$RBX_VERSION /tmp/rbx/rubinius
      
      echo "Unpacking" | indent
        cd /tmp/rbx/rubinius
        tar -zxvf rubinius.tar.gz 
        cd /tmp/rbx/rubinius/rubinius-rubinius-$RBX_VERSION

      echo "Compiling" | indent
        ./configure --prefix $CACHE/rbx --default-version=1.9
        rake install 

      return 0
    #fi 
    
  cd $old_path
}

install_gems() {
  echo "Installing bundler"
  rbx -S gem install bundler

  echo "Installing foreman"
  rbx -S gem install foreman
  return 2
}

bootstrap() {
  install_rbx
  install_gems
}

install_gems() {
  # if gemfile exists, bundle
  if [ -s $1/Gemfile ]; then
    echo "Gemfile found, bundling" | indent
    foreman run bundle
  fi
}

VERBOSE=
RBX_URL=https://github.com/rubinius/rubinius/tarball
RBX_VERSION="1.2.4"
BUILD_DIR=$1
CACHE_DIR=$2

bootstrap
install_gems
exit 1
foreman start


