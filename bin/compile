#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

ensure_env() {
  echo "Ensuring suitable environment"
  mkdir -p $CACHE
  mkdir -p $BUILD
  export $PATH="$CACHE:$PATH"
}


install_rbx() {
  if which rbx &>/dev/null ; then
    echo "rbx detected"
  else 
    echo "Installing rbx-head, with 1.9 support" 
    local old_path=$PWD

    git clone git://github.com/rubinius/rubinius.git /tmp/rubinius
    cd /tmp/rubinius
    ./configure --prefix $CACHE/rbx
    rake install 

    cd $old_path
  fi 
}

install_gems() {
  echo "Installing bundler"
  rbx -S gem install bundler

  echo "Installing foreman"
  return 2
}

bootstrap() {
  install_rbx
  install_gems
}

install_gems() {
  # if gemfile exists, bundle
  if [ -s $1/Gemfile ]; then
    echo "Gemfile found, bundling" | indent
    foreman run bundle
  fi
}

BUILD_DIR=$1
CACHE_DIR=$2

bootstrap
install_gems
exit 1
foreman start


